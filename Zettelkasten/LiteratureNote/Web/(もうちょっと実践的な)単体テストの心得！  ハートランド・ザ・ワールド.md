---
title: "(もうちょっと実践的な)単体テストの心得！ | ハートランド・ザ・ワールド"
source: "https://hldc.co.jp/blog/2023/06/08/11991/"
author:
published:
created: 2025-05-15
description:
tags:
  - "web"
  - "単体テスト"
---
## (もうちょっと実践的な)単体テストの心得！

2023年6月8日 | , ,

[Facebook](https://hldc.co.jp/#facebook "Facebook") [Hatena](https://hldc.co.jp/#hatena "Hatena") [X](https://hldc.co.jp/#x "X")

エンジニアの皆さん、単体テスト、どう書いてます？

あたりまえですが、コード書きながらテスト考えなきゃいけないわけで、  
キッチリ書こうとすると、なかなか工数膨らんでしまって大変タイヘン。

なにか上手いやり方はないものかChatGPTに聞いてみたら、  
「網羅的に、独立性を保って、なるべく早い時期に、うまいことやればいいんじゃないですか」(大分省略しています)  
だそうです。

うーん、もうちょっと実践的なHowtoないでしょうか。

ということで、うちのエンジニアたちから抽出した  
「もう少し実践的な単体テストの心得」  
を載せておきます。

みなさまのテスト効率化にお役立てください。

## 単体テストを作成する前に考えるべきこと

ここでの「単体テスト」の定義は、  
「小さな単位(関数など)のプログラムが単体で正常に動作することをテストコードを用いて確認すること」  
と定義します。  
(手動で実施する単体テストもあるが、昨今重要度が激増しているリグレッションテストなどを考慮すると現実的ではない)。

テストコードを作ることは調べれば簡単にできるが、  
実際はテストコードが作成しにくいコードに直面します。  
つまりそもそも「単体テストを作ろう！」以前に問題があるわけです。

まず身に付けるべきは  
「テストコードの書き方」では無く  
「テスト対象コード」すなわち「プロダクトコードの書き方」  
かと考えます。

## 単体テストを作りやすくするためのポイント

基本的なポイントとしては

- ビジネスロジックと環境に依存するものを分離する
- 何度繰り返しても同じ値が返るようにする

に分かれると考えています。  
それぞれについて説明しますね。

### ビジネスロジックと環境に依存するものを分離する

UIやファイル入出力、ネットワーク通信、DB処理などは、  
それらの環境を構築した状態で単体テストを実行する必要があります。  
なのでハードルがかなり高くなる。

また、単体テストの実行速度も遅くなるため（Slow Testというらしい）、  
ビジネスロジックの単体テスト（Quick Test）とは分けて考えた方が良いです。

で、これらを分離するためには、  
アーキテクチャ設計をきっちりしておくことが重要になります。

各レイヤーの依存関係を整理し、  
依存の方向を決めておくことで  
単体テストできる部分とできない部分を明確に分けておくわけです。

ここで重要なのは  
**「何を単体テストで担保しないのか」**  
という方針を決めること。

例えば

- DBへの読み書きは単体テストではなく結合テストで実施する
- 外部ライブラリの動作は事前調査で動作確認済みなので単体テストの対象には含めない
- UIは実動作で確認する

とかです。  
※UIのテストコードとかも作れるけど、ここで言っている単体テストよりはハードル高めなので、すべてのプロジェクトで実施したほうが良いとは思わないです。

次に依存関係の作り方について。  
様々な処理を組み合わせてシステムを作成していく以上、  
全く依存させないものを作ることは不可能です。

例えばコマンドパケットをネットワーク通信で受信するケースを考えた場合、

- コマンドを受信する部分
- コマンドを解析する部分
- コマンドレスポンス送信の部分

はどうしても依存してしまう。

以下のクラス図のケースを考えてみましょう。

![](https://hldc.co.jp/blog/wp-content/uploads/2023/05/HowtoUnitTest_StoryImage_ClassImage1.png)

コマンドを解析する部分にはビジネスロジックが含まれるため単体テストの対象としたいが、  
上記の場合だとレスポンス送信も一緒になっているため、  
実際のネットワーク通信ができる環境でテストする必要がありますね。

つまり、通信用のライブラリを使っている場合は、そのライブラリが入っている環境である必要があります。  
→ **ここで「単体テストが作れない･･･！」という絶望を味わったりします。**

自力での解決策としては、以下のような感じです。

●Step1  
ネットワーク通信部分をインターフェースとして定義することで、  
実体の差し替えができるような状態にする。  
これによりネットワーク送信を行うコマンドレスポンスクラスとは直接的には依存しなくなる。

●Step2  
コマンド解析クラスを生成する際にレスポンスクラスの実体を外から注入する。(これをDependency Injection：通常DIという)  
これで柔軟にテスト環境を変えることができる。

![](https://hldc.co.jp/blog/wp-content/uploads/2023/05/HowtoUnitTest_StoryImage_ClassImage2.png)

テスト時のクラス図は以下のようなイメージ。  
ネットワーク通信部分を切り離したことでコマンドの解析部分にのみフォーカスしてテストが実施できます。  
※ネットワーク通信の他にDBやファイル入出力なども同様に分離しましょう。

![](https://hldc.co.jp/blog/wp-content/uploads/2023/05/HowtoUnitTest_StoryImage_ClassImage3.png)

実際には様々な依存関係があるので、こんな簡単に解決することはないですが、  
こういった依存の整理を繰り返せば、テストしやすい環境を構築することができるでしょう。

それでも、開発が進むにつれて色々と違和感や不吉なにおいを感じることがありますが、  
そういった場合はリファクタリングして都度修正していくべきでしょう。

最初から完璧なものは作れないので、ある程度の妥協も必要と思います。

### 何度繰り返しても同じ値が返るようにする

単体テストは一般的に処理結果と期待値の比較によりOK、NGを判断するため、  
ある引数を与えて返ってくる結果が毎回異なるのでは単体テストになりません。

よって毎回結果が異なる処理はビジネスロジックを含む処理とは分離する必要があるわけです。

例えば以下のような処理が入っているものは要注意。

- 今日の日付を取得
- 乱数を算出
- 上記のような処理を含む関数を呼んでいる

上記のような処理を分離する方法としては、  
引数としてそれらの乱数を渡せるようにしておくのが最も簡単です。

## 何をテストするべきか

あたりまえかもしれませんが、以下は確認したほうが良いです。

- 同値分割
- 境界値分析
- 無効値/異常系

でも手動でやると手数が多くて結構面倒だったりします。  
最近流行ってる気がするテストの自動化環境なんかを構築してみると結構ラクなんですけどね。  
境界値分析みたいな、手数の勝負になりがちなテストは特に。

あと、無効値とか異常値とかはそもそも実動作だと容易に再現できないケースも多い。  
たとえば、火災報知器のセンサー制御みたいなのを書いたとして、  
テストで実際に火災おこすわけにはいかないわけです。

その他にも条件網羅（C2カバレッジ）なんかも確認できるとよいですね。

そういえば、  
うちの会社が無効値/異常値も手軽にテストできるようなテスト自動化ツールを作ってるので、  
良かったら見ていってください。  
安くパパっと始められるらしいです。

[テスト自動化プラットフォーム「AUTOmeal」](https://hldc.co.jp/product_service/development/test-automation/)

## 単体テストのメリット・デメリット

かんたんにですが、まとめておきます。

### メリット

- 不具合を早期発見できる（つまり、結合テスト以降に不具合を発見した際に問題の切り分けがしやすくなる）
- 不具合の修正が容易
- リグレッションテストができる
- テストを意識することで整理された実装ができる
- テスト仕様が更新されやすい
- コードに自信が持てる

### デメリット

- 開発工数の増加による開発者の負担増
- 開発者のレベル感による品質のばらつきが出る

## レガシーコードに対して

いろいろ書きましたが、  
アーキテクチャ設計をきっちり行って最初から整理されたプロジェクトを作っていく  
というのが一番良いのは間違いないわけです。

なんですが、どうにもならないときがあるのも事実です。  
脈々と開発されてきた、九龍城のごとき巨大コードの開発を引き継がねばならないときとか。

そういうときは、基本的に「諦めが肝心」というか、  
既存のコードにあまり変更を加えないようにしつつ、  
新規追加コードはちゃんと単体テストやっていくようにするのが、ちょうどいいかもしれません。

もしくは、単体テストの段階であっても積極的に「動的テストツール」なんかを活用していくのも手です。  
※動的テストって何？という方は↓をご参照ください。

[動的テストがぜんぶわかる！「はじめよう動的テスト」](https://hldc.co.jp/special/dynamic-test/)

[Facebook](https://hldc.co.jp/#facebook "Facebook") [Hatena](https://hldc.co.jp/#hatena "Hatena") [X](https://hldc.co.jp/#x "X")

### 関連記事

[![エージングログの整理が面倒なのでPythonにやらせてみた](https://hldc.co.jp/blog/wp-content/uploads/2023/07/EfficiencyWithPython_eyecatch-440x264.png)](https://hldc.co.jp/blog/2023/07/24/12046/ "エージングログの整理が面倒なのでPythonにやらせてみた")

#### エージングログの整理が面倒なのでPythonにやらせてみた

[![オーバーヘッド って何なんだ！！！？<BR>～ソフトの動的解析に付きまとう余計な処理時間を何とかしたい～](https://hldc.co.jp/blog/wp-content/uploads/2022/12/Eyecatch_WhatsaOverhead-440x264.png)](https://hldc.co.jp/blog/2022/12/15/11611/ "オーバーヘッド って何なんだ！！！？<BR>～ソフトの動的解析に付きまとう余計な処理時間を何とかしたい～")

#### オーバーヘッド って何なんだ！！！？～ソフトの動的解析に付きまとう余計な処理時間を何とかしたい～

[![ラズパイでテスト自動化システムを作って展示会に出展しました](https://hldc.co.jp/blog/wp-content/uploads/2019/11/IMG_3957-440x264.jpg)](https://hldc.co.jp/blog/2019/11/26/3287/ "ラズパイでテスト自動化システムを作って展示会に出展しました")

#### ラズパイでテスト自動化システムを作って展示会に出展しました

[![カバレッジを始めよう！#2 ～より強力なカバレッジ基準「ブランチカバレッジ」「MC/DC」～](https://hldc.co.jp/blog/wp-content/uploads/2017/08/img_graphs-440x264.png)](https://hldc.co.jp/blog/2017/11/21/720/ "カバレッジを始めよう！#2 ～より強力なカバレッジ基準「ブランチカバレッジ」「MC/DC」～")

#### カバレッジを始めよう！#2 ～より強力なカバレッジ基準「ブランチカバレッジ」「MC/DC」～

#### 今週の人気記事

- [![](https://hldc.co.jp/blog/wp-content/uploads/2019/07/bd517b7c76f5da2370f9f87c70a28f34_m-150x150.jpg)](https://hldc.co.jp/blog/2019/07/11/2819/ "TCPとUDPの違いとは？～Ethernet接続におけるオーバーヘッド削減ノウハウ～") [TCPとUDPの違いとは？  
	～Ethernet接続におけるオーバーヘッド削減ノウハウ～](https://hldc.co.jp/blog/2019/07/11/2819/ "TCPとUDPの違いとは？～Ethernet接続におけるオーバーヘッド削減ノウハウ～") 779件のビュー
- [![](https://hldc.co.jp/blog/wp-content/uploads/2020/04/wallpaper-shark-photo-01-150x150.jpg)](https://hldc.co.jp/blog/2020/04/15/3988/ "Wiresharkの使い方～Wiresharkで「TCP/IP」モデルをのぞき見る～") [Wiresharkの使い方  
	～Wiresharkで「TCP/IP」モデルをのぞき見る～](https://hldc.co.jp/blog/2020/04/15/3988/ "Wiresharkの使い方～Wiresharkで「TCP/IP」モデルをのぞき見る～") 335件のビュー
- [![](https://hldc.co.jp/blog/wp-content/uploads/2017/08/img_graphs-2-150x150.png)](https://hldc.co.jp/blog/2019/03/29/2331/) [「SIL」「ASIL」とは？機能安全規格の開発を始めるにあたり知っておきたいこと。](https://hldc.co.jp/blog/2019/03/29/2331/) 216件のビュー
- [![](https://hldc.co.jp/blog/wp-content/uploads/2017/08/img_graphs-150x150.png)](https://hldc.co.jp/blog/2022/09/08/1211/) [今さら聞けない「動的テスト」「静的テスト」とは？](https://hldc.co.jp/blog/2022/09/08/1211/) 202件のビュー
- [![](https://hldc.co.jp/blog/wp-content/uploads/2020/04/LinuxMemInfo_Welcome-150x150.png)](https://hldc.co.jp/blog/2020/06/04/4130/) [組込みLinuxのメモリ使用率をリアルタイムに監視する方法](https://hldc.co.jp/blog/2020/06/04/4130/) 132件のビュー

#### 最新の記事

- [![イラスト付きでわかりやすく解説！開発プロセスとは？](https://hldc.co.jp/blog/wp-content/uploads/2025/04/77d0d6a051d6497df8380beb1c9e20b3-150x150.png)](https://hldc.co.jp/blog/2025/05/08/14913/ "イラスト付きでわかりやすく解説！開発プロセスとは？")
	[イラスト付きでわかりやすく解説！開発プロセスとは？](https://hldc.co.jp/blog/2025/05/08/14913/)
	2025年5月8日 | ,
- [![【連載】ラズパイとPythonでテスト自動化やってみた #5～AUTOmeal:CAN通信編～](https://hldc.co.jp/blog/wp-content/uploads/2025/03/AutomealAdaption_pt1_eyecatch-1280x640-1-150x150.png)](https://hldc.co.jp/blog/2025/04/01/14625/ "【連載】ラズパイとPythonでテスト自動化やってみた #5～AUTOmeal:CAN通信編～")
	[【連載】ラズパイとPythonでテスト自動化やってみた #5～AUTOmeal:CAN通信編～](https://hldc.co.jp/blog/2025/04/01/14625/)
	2025年4月1日 | ,
- [![未来のエンジニア誕生？<br>地域企業が贈るプログラミング授業とは<br>【足利市立山前小編】](https://hldc.co.jp/blog/wp-content/uploads/2025/03/f2f8b90deaed692ebad3888bb18ccdc5-150x150.png)](https://hldc.co.jp/blog/2025/03/14/14702/ "未来のエンジニア誕生？<br>地域企業が贈るプログラミング授業とは<br>【足利市立山前小編】")
	[未来のエンジニア誕生？  
	地域企業が贈るプログラミング授業とは  
	【足利市立山前小編】](https://hldc.co.jp/blog/2025/03/14/14702/)
	2025年3月14日 | , , , ,
- [![「ゲーム作りってこんなに楽しい！」<br>小学生がはじめてのプログラミングに挑戦！<br>【プログラミング授業 / 小俣小編】](https://hldc.co.jp/blog/wp-content/uploads/2024/12/276df5662514b18c2736409998147472-150x150.png)](https://hldc.co.jp/blog/2024/12/25/14572/ "「ゲーム作りってこんなに楽しい！」<br>小学生がはじめてのプログラミングに挑戦！<br>【プログラミング授業 / 小俣小編】")
	[「ゲーム作りってこんなに楽しい！」  
	小学生がはじめてのプログラミングに挑戦！  
	【プログラミング授業 / 小俣小編】](https://hldc.co.jp/blog/2024/12/25/14572/)
	2024年12月25日 | , , , ,
- [![【連載】ラズパイとPythonでテスト自動化やってみた ～AUTOmeal:シリアル通信編～](https://hldc.co.jp/blog/wp-content/uploads/2022/09/AutomealAdaption_pt4_eyecatch-150x150.png)](https://hldc.co.jp/blog/2024/10/17/14365/ "【連載】ラズパイとPythonでテスト自動化やってみた ～AUTOmeal:シリアル通信編～")
	[【連載】ラズパイとPythonでテスト自動化やってみた ～AUTOmeal:シリアル通信編～](https://hldc.co.jp/blog/2024/10/17/14365/)
	2024年10月17日 | ,

[もっと](https://hldc.co.jp/blog/2023/06/08/11991/#addtoany "すべてを表示")